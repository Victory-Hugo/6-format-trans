# VCF to EIGENSTRAT Format Conversion

这个目录包含将VCF格式转换为EIGENSTRAT格式的脚本，用于群体遗传学分析。

## 文件说明

- `1.sh` - 主要转换脚本（标准版）
- `1_enhanced.sh` - 增强版转换脚本（推荐，自动处理重复ID问题）
- `preprocess_vcf.sh` - VCF预处理脚本（处理重复ID）
- `update_population_labels.sh` - 群体标签更新辅助脚本
- `README.md` - 使用说明文档

## 使用步骤

### 快速开始（推荐）

如果遇到重复ID问题，直接使用增强版脚本：

```bash
cd /mnt/f/OneDrive/文档（科研）/脚本/Download/6-format-trans/5-geno-ind-snp/script
./1_enhanced.sh
```

增强版脚本会自动：
- 检测VCF文件中的重复ID
- 如果发现重复ID，自动进行预处理
- 使用多种策略确保PLINK转换成功

### 标准流程

1. **运行主转换脚本**：

```bash
cd /mnt/f/OneDrive/文档（科研）/脚本/Download/6-format-trans/5-geno-ind-snp/script
./1.sh
```

### 手动处理重复ID问题

如果遇到 "Duplicate ID" 错误：

```bash
# 方法1: 使用预处理脚本
./preprocess_vcf.sh input.vcf.gz output_fixed.vcf.gz

# 方法2: 使用bcftools（如果可用）
bcftools annotate --set-id '%CHROM\_%POS\_%REF\_%ALT' input.vcf.gz -O z -o output_fixed.vcf.gz
```

### 2. 更新群体标签

转换完成后，需要更新.ind文件中的群体标签：

#### 方法1: 交互式更新
```bash
./update_population_labels.sh /path/to/output/7544_filtered_pruned_data.ind
```

#### 方法2: 批量更新（推荐）
如果有样本-群体对应文件：
```bash
./update_population_labels.sh /path/to/output/7544_filtered_pruned_data.ind sample_population_map.txt
```

样本-群体对应文件格式：
```
SampleID1    East_Asia
SampleID2    Europe
SampleID3    Africa
...
```

#### 方法3: 简单批量替换
如果所有样本属于同一群体：
```bash
sed -i 's/\?$/East_Asia/g' /path/to/output/7544_filtered_pruned_data.ind
```

## 输出文件

转换成功后将生成以下EIGENSTRAT格式文件：

- `*.geno` - 基因型数据矩阵
- `*.snp` - SNP位点信息
- `*.ind` - 样本信息（包含群体标签）

## 文件格式说明

### .geno文件
- 每行代表一个SNP位点
- 每列代表一个样本
- 0=主要等位基因纯合子，1=杂合子，2=次要等位基因纯合子，9=缺失

### .snp文件
格式：`SNP_ID chromosome genetic_distance physical_position ref_allele alt_allele`

### .ind文件
格式：`SampleID Sex Population`
- Sex: M=男性，F=女性，U=未知
- Population: 群体标签

## 注意事项

1. 确保PLINK和CONVERTF工具已正确安装
2. 检查输入VCF文件路径是否正确
3. 转换前会自动创建输出目录
4. 脚本包含错误检查，遇到错误会自动停止
5. 所有原始文件都会自动备份

## 故障排除

### 常见错误及解决方法

1. **Duplicate ID 错误**
   ```
   Error: Duplicate ID 'NC_000915.1:5' generated by --set-missing-var-ids.
   ```
   
   **解决方案**：
   - 使用增强版脚本：`./1_enhanced.sh`
   - 或手动预处理：`./preprocess_vcf.sh input.vcf.gz fixed.vcf.gz`

2. **PLINK命令失败**
   - 检查VCF文件是否存在且格式正确
   - 确保有足够的磁盘空间
   - 尝试增强版脚本的分步处理方法

3. **CONVERTF转换失败**
   - 检查EIGENSOFT是否正确安装
   - 验证PLINK输出文件是否完整

4. **文件一致性检查失败**
   - 检查中间文件是否完整生成
   - 重新运行脚本

### 重复ID问题的技术说明

VCF文件中的重复ID通常出现在：
- 同一位置有多个变异记录
- ID列为空时PLINK自动生成的ID重复

增强版脚本使用以下策略解决：
1. 自动检测重复ID
2. 使用 `染色体_位置_参考_替代_行号` 格式生成唯一ID
3. 如果预处理失败，使用分步转换方法

## 依赖软件

- PLINK (v1.9或更高版本)
- EIGENSOFT (包含convertf工具)

## 作者

[请填写作者信息]

## 更新日志

- 2025-07-08: 初始版本，包含完整的VCF到EIGENSTRAT转换流程
